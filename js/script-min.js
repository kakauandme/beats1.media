function processTrack(t){if(1==t.resultCount){var e=t.results[0];if("USA"!==e.country){var r=e.trackViewUrl,a=(e.trackName+" "+e.artistName).toLowerCase().replace(/[^a-z0-9\s]/gi,"").replace(/\s+/gi,"-");try{localStorage.setItem(a+"-"+country,r)}catch(s){console.error("Localstorage error: "+s),localStorage.clear()}(element=document.getElementById("link-"+a))?element.href=r:console.error(a+" track doesn't match")}}}function processGeolocation(t){t&&(country=t.country.toLowerCase(),global.updateUrls(country))}var stylesheet=document.createElement("link");if(stylesheet.href="/css/top."+cacheBuster+".css",stylesheet.rel="stylesheet",stylesheet.type="text/css",stylesheet.media="all",document.getElementsByTagName("head")[0].appendChild(stylesheet),dom.listing=document.getElementById("listing"),dom.tracks=document.querySelectorAll(".show-track"),dom.selectedArtwork=document.getElementById("selected-artwork"),dom.selectedTrack=document.getElementById("selected-track-link"),dom.selectedLink=document.getElementById("selected-link"),dom.footer=document.getElementById("footer"),dom.title=document.getElementById("title"),dom.graph=document.getElementById("graph"),dom.close=document.getElementById("close"),global.createCookie=function(t,e,r){var a="";if(r){var s=new Date;s.setTime(s.getTime()+24*r*60*60*1e3),a="; expires="+s.toGMTString()}document.cookie=t+"="+e+a+"; path=/"},global.readCookie=function(t){for(var e=t+"=",r=document.cookie.split(";"),a=0;a<r.length;a++){for(var s=r[a];" "===s.charAt(0);)s=s.substring(1,s.length);if(0===s.indexOf(e))return s.substring(e.length,s.length)}return null},global.updateUrls=function(t){if(global.createCookie("country",t,30),"us"!==t&&"undefined"!=typeof Storage)for(var e=dom.listing.querySelectorAll("a.preview"),r=e.length-1;r>=0;r--){var a=e[r].getAttribute("data-target-id");if(url=localStorage.getItem(a+"-"+t))e[r].href=url;else{var s=encodeURIComponent(e[r].getAttribute("data-artist")+" "+e[r].getAttribute("data-album")+" "+e[r].getAttribute("data-track"));global.loadScript("http://itunes.apple.com/search?term="+s+"&media=music&entity=song&limit=1&callback=processTrack&country="+t)}}},global.easeInOut=function(t,e,r,a){return t/=a/2,1>t?r/2*t*t+e:(t-=1,-r/2*(t*(t-2)-1)+e)},global.scrollTo=function(t,e,r){var a=t.scrollTop,s=e-a,o=20,n=function(e){e+=o;var l=global.easeInOut(e,a,s,r);t.scrollTop=l,r>e&&setTimeout(function(){n(e)},o)};n(0)},global.selectTrack=function(t){var e=t.getAttribute("data-src");dom.selectedArtwork.src=e,dom.selectedArtwork.className="",t.className+=" selected",dom.selectedArtwork.alt=dom.selectedTrack.title=dom.selectedLink.title=dom.selectedTrack.textContent=t.title,dom.selectedTrack.href=dom.selectedLink.href=t.getElementsByTagName("a")[0].href;for(var r=artworkSizes[artworkSizes.length-1],a=0;a<artworkSizes.length;a++)if(dom.selectedArtwork.offsetWidth<=artworkSizes[a]){r=artworkSizes[a];break}var s=new Image;s.onload=function(){dom.selectedArtwork.src=s.src,dom.selectedArtwork.className="loaded"},s.src=e.replace("100x100",r+"x"+r),dom.listing.scrollTop&&global.scrollTo(listing,0,500)},global.clickTrack=function(t){"TR"!==this.tagName&&t.preventDefault(),dom.body.className="listing-open";var e=dom.listing.querySelector("tr.selected");e&&(e.className=e.className.replace(" selected",""));var r=this.getAttribute("data-target-id");window.location.hash=r;var a=document.getElementById("track-"+r);a&&global.selectTrack(a)},window.location.hash.length>1){var target=document.getElementById("track-"+window.location.hash.substring(1));target&&(dom.body.className="listing-open",global.selectTrack(target))}if(dom.close&&dom.close.addEventListener("click",function(t){t.preventDefault(),history.pushState({},"","#"),dom.body.className=""},!1),dom.listing){for(var i=dom.tracks.length-1;i>=0;i--)dom.tracks[i].addEventListener("click",global.clickTrack,!0);var country=global.readCookie("country");country?global.updateUrls(country):global.loadScript("http://ipinfo.io/?callback=processGeolocation")}var svg=svg||{};global.drawD3=function(){svg.pad=dom.title.offsetTop,svg.w=dom.graph.offsetWidth-2*svg.pad,svg.h=dom.graph.offsetHeight-dom.title.offsetHeight-dom.footer.offsetHeight-2*svg.pad,svg.radius=Math.max(Math.min(Math.min(svg.w,svg.h)/10,50),25),svg.xDomain=[d3.min(topAlbums,function(t){return+t[svg.xKey]}),d3.max(topAlbums,function(t){return+t[svg.xKey]})],svg.tDomain=[d3.max(topAlbums,function(t){return+t[svg.tKey]}),d3.min(topAlbums,function(t){return+t[svg.tKey]})],svg.yDomain=[d3.min(topAlbums,function(t){return+t[svg.yKey]}),d3.max(topAlbums,function(t){return+t[svg.yKey]})],svg.rDomain=[d3.min(topAlbums,function(t){return+t[svg.rKey]}),d3.max(topAlbums,function(t){return+t[svg.rKey]})],svg.x=d3.time.scale().domain(svg.xDomain).range([svg.radius+2*svg.pad,svg.w-svg.radius]),svg.y=d3.scale.linear().domain(svg.yDomain).range([svg.h-svg.radius-2*svg.pad,svg.radius]),svg.r=d3.scale.linear().domain(svg.rDomain).range([svg.radius/3,svg.radius]),svg.t=d3.scale.linear().domain(svg.tDomain).range([0,1e4]),svg.xAxis.scale(svg.x),svg.yAxis.scale(svg.y),svg.canvas.attr("width",svg.w).attr("height",svg.h),svg.xAxisGroup.attr("transform","translate(0, "+(svg.h-6)+")").call(svg.xAxis),svg.yAxisGroup.call(svg.yAxis),svg.legend.selectAll("text").attr("x",svg.w-svg.radius-24).attr("y",svg.radius),svg.legend.selectAll("circle").attr("cx",svg.w-svg.radius-9).attr("cy",svg.radius),svg.xLabel.attr("x",svg.w-svg.radius).attr("y",svg.h-Math.max(svg.pad,14)),svg.yLabel.attr("x",-svg.radius).attr("y",svg.pad),svg.circles.attr("cx",function(t){return svg.x(+t[svg.xKey])}).attr("cy",function(t){return svg.y(+t[svg.yKey])}).attr("r",5).style("stroke-width",Math.floor(svg.radius/10)).style("fill-opacity",1e-6).style("stroke-opacity",1e-6).transition().duration(500).delay(function(t){return svg.t(+t[svg.tKey])}).attr("r",function(t){return svg.r(+t[svg.rKey])}).style("fill-opacity",1).style("stroke-opacity",1)},global.setupD3=function(t){d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},d3.selection.prototype.moveToBack=function(){return this.each(function(){var t=this.parentNode.firstChild;t&&this.parentNode.insertBefore(this,t)})},svg.pad=dom.title.offsetTop,svg.yKey="totalPlays",svg.xKey="firstPlay",svg.rKey="numberOfTracks",svg.cKey="primaryGenreName",svg.tKey="lastPlay",svg.canvas=d3.select("#graph").append("svg"),svg.cValue=function(t){return t[svg.cKey]},svg.color=d3.scale.category20(),svg.xAxisGroup=svg.canvas.append("g").attr("class","axis"),svg.yAxisGroup=svg.canvas.append("g").attr("class","axis").attr("transform","translate(5, 0)"),svg.xAxis=d3.svg.axis().orient("bottom").tickFormat(function(t){return""}),svg.yAxis=d3.svg.axis().orient("left").tickFormat(function(t){return""}),svg.canvas.append("defs").selectAll("pattern").data(topAlbums).enter().append("pattern").attr("id",function(t){return t.collectionId}).attr("x",0).attr("y",0).attr("width","100%").attr("height","100%").attr("viewBox","0 0 100 100").append("image").attr("xlink:href",function(t){return t.artworkUrl100}).attr("x",0).attr("y",0).attr("width",100).attr("height",100),svg.circles=svg.canvas.selectAll("circle").data(topAlbums).enter().append("circle"),svg.circles.on("mouseover",function(){d3.select(this).moveToFront().transition().duration(500).style("stroke-width",1).attr("r",function(t){return svg.radius+1})}),svg.circles.on("mouseout",function(){var t=d3.select(this);t.transition().duration(250).style("stroke-width",Math.floor(svg.radius/10)).attr("r",function(t){return svg.r(+t[svg.rKey])}),setTimeout(function(){t.moveToBack()},251)}),svg.circles.attr("class","circle").style("fill",function(t){return"url(#"+t.collectionId+")"}).style("stroke",function(t){return svg.color(svg.cValue(t))}).append("svg:title").text(function(t){return t.collectionName+" â€” "+t.artistName}),svg.legend=svg.canvas.selectAll(".legend").data(svg.color.domain()).enter().append("g").attr("class","legend").attr("transform",function(t,e){return"translate(0,"+24*e+")"}),svg.legend.append("circle").attr("r",9).style("fill",svg.color),svg.legend.append("text").attr("dy",".35em").style("text-anchor","end").text(function(t){return t}),svg.xLabel=svg.canvas.append("g").attr("class","label").append("text").attr("dy",".35em").style("text-anchor","end").text("release date"),svg.yLabel=svg.canvas.append("g").attr("class","label").append("text").attr("transform","rotate(-90)").attr("dy",".35em").style("text-anchor","end").text("amount of plays"),global.drawD3(),window.addEventListener("resize",global.drawD3)},dom.graph&&global.loadScript("http://d3js.org/d3.v3.min.js",global.setupD3);