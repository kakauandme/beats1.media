function processTrack(t){if(1==t.resultCount){var e=t.results[0];if("USA"!==e.country){var a=e.trackViewUrl,r=(e.trackName+" "+e.artistName).toLowerCase().replace(/[^a-z0-9\s]/gi,"").replace(/\s+/gi,"-");try{localStorage.setItem(r+"-"+country,a)}catch(o){console.error("Localstorage error: "+o),localStorage.clear()}(element=document.getElementById("link-"+r))?element.href=a:console.error(r+" track doesn't match")}}}function processGeolocation(t){t&&(country=t.country.toLowerCase(),global.updateUrls(country))}var svg=svg||{};if(global.drawD3=function(){svg.pad=dom.links[0].offsetLeft,svg.w=dom.graph.offsetWidth-2*svg.pad,svg.h=dom.graph.offsetHeight-dom.footer.offsetHeight-dom.title.offsetHeight,svg.radius=Math.max(Math.min(Math.min(svg.w,svg.h)/10,50),25),svg.xDomain=[d3.min(topAlbums,function(t){return+t[svg.xKey]}),d3.max(topAlbums,function(t){return+t[svg.xKey]})],svg.tDomain=[d3.max(topAlbums,function(t){return+t[svg.tKey]}),d3.min(topAlbums,function(t){return+t[svg.tKey]})],svg.yDomain=[d3.min(topAlbums,function(t){return+t[svg.yKey]}),d3.max(topAlbums,function(t){return+t[svg.yKey]})],svg.rDomain=[d3.min(topAlbums,function(t){return+t[svg.rKey]}),d3.max(topAlbums,function(t){return+t[svg.rKey]})],svg.x=d3.scale.linear().domain(svg.xDomain).range([svg.radius+2*svg.pad,svg.w-svg.radius]),svg.y=d3.scale.linear().domain(svg.yDomain).range([svg.h-svg.radius-2*svg.pad,svg.radius]),svg.xA=d3.scale.linear().domain([0,100]).range([0,svg.w]),svg.yA=d3.scale.linear().domain([0,100]).range([svg.h,0]),svg.r=d3.scale.linear().domain(svg.rDomain).range([svg.radius/3,svg.radius]),svg.t=d3.scale.linear().domain(svg.tDomain).range([0,1e4]),svg.xAxis.scale(svg.xA),svg.yAxis.scale(svg.yA),svg.canvas.attr("width",svg.w).attr("height",svg.h),svg.xAxisGroup.attr("transform","translate(5, "+(svg.h-5)+")").call(svg.xAxis),svg.yAxisGroup.call(svg.yAxis),svg.legend.selectAll("text").attr("x",svg.w-1.5*svg.pad).attr("y",svg.pad/2),svg.legend.selectAll("circle").attr("cx",svg.w-svg.pad/2).attr("cy",svg.pad/2),svg.xLabel.attr("x",svg.w).attr("y",svg.h-1.2*svg.pad),svg.yLabel.attr("x",0).attr("y",svg.pad),svg.circles.attr("cx",function(t){return svg.x(+t[svg.xKey])}).attr("cy",function(t){return svg.y(+t[svg.yKey])}).attr("r",5).style("stroke-width",Math.floor(svg.radius/10)).style("fill-opacity",1e-6).style("stroke-opacity",1e-6).transition().duration(500).delay(function(t){return svg.t(+t[svg.tKey])}).attr("r",function(t){return svg.r(+t[svg.rKey])}).style("fill-opacity",1).style("stroke-opacity",1)},global.setupD3=function(t){d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},d3.selection.prototype.moveToBack=function(){return this.each(function(){var t=this.parentNode.firstChild;t&&this.parentNode.insertBefore(this,t)})},svg.pad=dom.links[0].offsetLeft,svg.yKey="totalPlays",svg.xKey="firstPlay",svg.rKey="numberOfTracks",svg.cKey="primaryGenreName",svg.tKey="lastPlay",svg.canvas=d3.select("#graph").append("svg"),svg.cValue=function(t){return t[svg.cKey]},svg.color=d3.scale.category20(),svg.xAxisGroup=svg.canvas.append("g").attr("class","axis"),svg.yAxisGroup=svg.canvas.append("g").attr("class","axis").attr("transform","translate(5, -5)"),svg.xAxis=d3.svg.axis().orient("bottom").tickFormat(function(t){return""}),svg.yAxis=d3.svg.axis().orient("left").tickFormat(function(t){return""}),svg.canvas.append("defs").selectAll("pattern").data(topAlbums).enter().append("pattern").attr("id",function(t){return t.collectionId}).attr("x",0).attr("y",0).attr("width","100%").attr("height","100%").attr("viewBox","0 0 100 100").append("image").attr("xlink:href",function(t){return t.artworkUrl100}).attr("x",0).attr("y",0).attr("width",100).attr("height",100),svg.circles=svg.canvas.selectAll("circle").data(topAlbums).enter().append("circle"),svg.circles.on("mouseover",function(){d3.select(this).moveToFront().transition().duration(500).style("stroke-width",2).attr("r",function(t){return svg.radius+1})}),svg.circles.on("mouseout",function(){var t=d3.select(this);t.transition().duration(250).style("stroke-width",Math.floor(svg.radius/10)).attr("r",function(t){return svg.r(+t[svg.rKey])}),setTimeout(function(){t.moveToBack()},251)}),svg.circles.attr("class","circle").style("fill",function(t){return"url(#"+t.collectionId+")"}).style("stroke",function(t){return svg.color(svg.cValue(t))}).append("svg:title").text(function(t){return t.collectionName+" â€” "+t.artistName}),svg.legend=svg.canvas.selectAll(".legend").data(svg.color.domain()).enter().append("g").attr("class","legend").attr("transform",function(t,e){return"translate(0,"+e*svg.pad*1.5+")"}),svg.legend.append("circle").attr("r",svg.pad/2).style("fill",svg.color),svg.legend.append("text").attr("dy","0.35em").style("text-anchor","end").text(function(t){return t}),svg.xLabel=svg.canvas.append("g").attr("class","label").append("text").attr("dy",".35em").style("text-anchor","end").text("release date"),svg.yLabel=svg.canvas.append("g").attr("class","label").append("text").attr("transform","rotate(-90)").attr("dy",".35em").style("text-anchor","end").text("amount of plays"),global.drawD3(),window.addEventListener("resize",global.drawD3)},dom.listing=document.getElementById("listing"),dom.tracks=document.querySelectorAll(".show-track"),dom.selectedArtwork=document.getElementById("selected-artwork"),dom.selectedTrack=document.getElementById("selected-track-link"),dom.selectedLink=document.getElementById("selected-link"),dom.footer=document.getElementById("footer"),dom.title=document.getElementById("title"),dom.graph=document.getElementById("graph"),dom.close=document.getElementById("close"),dom.now=document.getElementById("now"),dom.cover=document.getElementById("cover"),dom.play=document.getElementById("play"),dom.audio=document.getElementById("audio"),dom.links=document.getElementById("links").children,global.navClick=function(t){t.preventDefault(),window.location.href=t.target.href},global.createCookie=function(t,e,a){var r="";if(a){var o=new Date;o.setTime(o.getTime()+24*a*60*60*1e3),r="; expires="+o.toGMTString()}document.cookie=t+"="+e+r+"; path=/"},global.readCookie=function(t){for(var e=t+"=",a=document.cookie.split(";"),r=0;r<a.length;r++){for(var o=a[r];" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(e))return o.substring(e.length,o.length)}return null},global.updateUrls=function(t){if(global.createCookie("country",t,30),"us"!==t&&"undefined"!=typeof Storage){var e=[];dom.listing?e=dom.listing.querySelectorAll("a.preview"):dom.now&&(e=dom.now.querySelectorAll("a.preview"));for(var a=0;a<e.length;a++){var r=e[a].getAttribute("data-target-id");if(url=localStorage.getItem(r+"-"+t))e[a].href=url;else{var o=encodeURIComponent(e[a].getAttribute("data-artist")+" "+e[a].getAttribute("data-album")+" "+e[a].getAttribute("data-track"));global.loadScript("http://itunes.apple.com/search?term="+o+"&media=music&entity=song&limit=1&callback=processTrack&country="+t)}}}},global.easeInOut=function(t,e,a,r){return t/=r/2,1>t?a/2*t*t+e:(t-=1,-a/2*(t*(t-2)-1)+e)},global.scrollTo=function(t,e,a){var r=t.scrollTop,o=e-r,s=20,n=function(e){e+=s;var l=global.easeInOut(e,r,o,a);t.scrollTop=l,a>e&&setTimeout(function(){n(e)},s)};n(0)},global.selectTrack=function(t){var e=t.getAttribute("data-src");dom.selectedArtwork.src=e,dom.selectedArtwork.className="",t.className+=" selected",dom.selectedArtwork.alt=dom.selectedTrack.textContent=t.title,dom.selectedTrack.href=dom.selectedLink.href=t.getElementsByTagName("a")[0].href;for(var a=artworkSizes[artworkSizes.length-1],r=0;r<artworkSizes.length;r++)if(dom.selectedArtwork.offsetWidth<=artworkSizes[r]){a=artworkSizes[r];break}var o=new Image;o.onload=function(){dom.selectedArtwork.src=o.src,dom.selectedArtwork.className="loaded"},o.src=e.replace("100x100",a+"x"+a),dom.listing.scrollTop&&global.scrollTo(listing,0,500)},global.clickTrack=function(t){"TR"!==this.tagName&&t.preventDefault(),dom.body.className="listing-open";var e=dom.listing.querySelector("tr.selected");e&&(e.className=e.className.replace(" selected",""));var a=this.getAttribute("data-target-id"),r=document.getElementById("track-"+a);r&&(global.selectTrack(r),history.pushState({},"","#"+a))},window.location.hash.length>2){var target=document.getElementById("track-"+window.location.hash.substring(1));target&&(dom.body.className="listing-open",global.selectTrack(target))}if(dom.close&&dom.close.addEventListener("click",function(t){t.preventDefault(),dom.body.className="",history.pushState({},"","#")},!1),dom.listing)for(var i=0;i<dom.tracks.length;i++)dom.tracks[i].addEventListener("click",global.clickTrack,!0);dom.graph&&global.loadScript("http://d3js.org/d3.v3.min.js",global.setupD3),global.playPause=function(){dom.cover.className.length?(dom.cover.className="",dom.play.textContent="play",dom.cover.title="Play",dom.audio.pause()):(dom.cover.className="playing",dom.play.textContent="pause",dom.cover.title="Pause",dom.audio.play())},dom.cover&&dom.cover.addEventListener("click",global.playPause,!0);for(var i=0;i<dom.links.length;i++)dom.links[i].addEventListener("click",global.navClick,!0);var country=global.readCookie("country");country?global.updateUrls(country):global.loadScript("http://ipinfo.io/?callback=processGeolocation");