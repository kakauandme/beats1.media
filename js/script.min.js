function processAlbum(t){if(1==t.resultCount){var e=t.results[0];if("USA"!==e.country){var a=e.collectionViewUrl,r=(e.collectionName+" "+e.artistName).toLowerCase().replace(/[^a-z0-9\s]/gi,"").replace(/\s+/gi,"-");try{localStorage.setItem(r+"-"+global.country,a)}catch(s){console.error("Localstorage error: "+s),localStorage.clear()}dom.title.firstChild&&dom.title.firstChild.textContent.substr(0,3)===e.collectionName.substr(0,3)&&(dom.title.firstChild.href=a)}}}function processTrack(t){if(1==t.resultCount){var e=t.results[0];if("USA"!==e.country){var a=e.trackViewUrl,r=(e.trackName+" "+e.artistName).toLowerCase().replace(/[^a-z0-9\s]/gi,"").replace(/\s+/gi,"-");try{localStorage.setItem(r+"-"+global.country,a)}catch(s){console.error("Localstorage error: "+s),localStorage.clear()}(element=document.getElementById("link-"+r))?element.href=a:console.error(r+" track doesn't match")}}}function processGeolocation(t){t&&(global.country=t.country.toLowerCase(),global.updateUrls(global.country))}var svg=svg||{};if(svg.setAlbumTitle=function(t){if(dom.title.innerHTML="<a target='_blank' href='"+t.trackViewUrl+"' title='Open in Apple Music'>"+t.collectionName+" — "+t.artistName+"</a>",global.country&&"us"!==global.country&&"undefined"!=typeof Storage){var e=(t.collectionName+" "+t.artistName).toLowerCase().replace(/[^a-z0-9\s]/gi,"").replace(/\s+/gi,"-");if(url=localStorage.getItem(e+"-"+global.country))dom.title.firstChild.href=url;else{var a=encodeURIComponent(t.collectionName+" "+t.artistName);global.loadScript("http://itunes.apple.com/search?term="+a+"&media=music&entity=album&limit=1&callback=processAlbum&country="+global.country)}}},svg.click=function(t){if(d3.event.stopPropagation(),svg.active.node()===this)return svg.reset();if(svg.reset(),svg.setAlbumTitle(t),svg.active=d3.select(this).classed("active",!0),0==svg.active.attr("data-zoomed")){svg.active.attr("data-zoomed",1);var e=d3.select("pattern#artwork-"+svg.active.attr("data-id")+" image");e.attr("xlink:href",t.artworkUrl100.replace("100x100",svg.bigImageSize+"x"+svg.bigImageSize))}svg.active.moveToFront().transition().duration(500).style("stroke-width",svg.pad).attr("r",Math.floor(Math.min(svg.w,svg.h)/2)-2*svg.pad).attr("cy",Math.floor(svg.h/2)).attr("cx",Math.floor(svg.w/2))},svg.filter=function(t){if(d3.event.stopPropagation(),svg.genre.node()===this)return svg.clearFilters();svg.genre.classed("active",!1),svg.genre=d3.select(this).classed("active",!0),svg.curGenre=svg.genre.attr("data-id"),svg.setGenreTitle(svg.curGenre);for(var e=0;e<svg.dataByGenre.length;e++)if(svg.dataByGenre[e].key===svg.curGenre){svg.data=svg.dataByGenre[e].values;break}history.pushState({},"","#"+svg.genreShortName(svg.curGenre)),svg.drawD3()},svg.clearFilters=function(){svg.genre.empty()||(svg.genre.classed("active",!1),svg.genre=d3.select(null),svg.data=topAlbums,svg.setGenreTitle(),svg.curGenre=null,history.pushState({},"","#"),svg.drawD3())},svg.reset=function(){svg.active.empty()||(svg.active.transition().duration(500).attr("cx",function(t){return svg.x(+t[svg.xKey])}).attr("cy",function(t){return svg.y(+t[svg.yKey])}).style("stroke-width",Math.floor(svg.radius/10)).attr("r",function(t){return svg.r(+t[svg.rKey])}),svg.active.classed("active",!1),svg.active=d3.select(null),svg.setGenreTitle(svg.curGenre))},svg.hover=function(t){svg.active.node()!==this&&d3.select(this).moveToFront().transition().duration(500).style("stroke-width",Math.floor(svg.radius/10)).attr("cx",svg.x(+t[svg.xKey])).attr("cy",svg.y(+t[svg.yKey])).attr("r",svg.radius)},svg.hoverOut=function(t){if(svg.active.node()!==this){var e=d3.select(this);e.transition().duration(250).style("stroke-width",Math.floor(svg.radius/10)).attr("cx",svg.x(+t[svg.xKey])).attr("cy",svg.y(+t[svg.yKey])).attr("r",svg.r(+t[svg.rKey])),setTimeout(function(){e.moveToBack()},251)}},svg.genreShortName=function(t){return t.toLowerCase().replace(/[^a-z]/g,"")},svg.setGenreTitle=function(t){if(t){var e=dom.title.getAttribute("data-text").split("100 ");dom.title.textContent=e[0]+"100 "+t+" "+e[1]}else dom.title.textContent=dom.title.getAttribute("data-text")},svg.drawD3=function(){svg.pad=dom.links[0].offsetLeft,svg.w=dom.graph.offsetWidth-2*svg.pad,svg.h=dom.graph.offsetHeight-dom.footer.offsetHeight-dom.title.offsetHeight,svg.bigImageSize=global.getImageWidth(Math.min(svg.w,svg.h)-2*svg.pad),svg.radius=Math.max(Math.min(Math.min(svg.w,svg.h)/10,50),25),svg.xDomain=d3.extent(svg.data,function(t){return+t[svg.xKey]}),svg.yDomain=d3.extent(svg.data,function(t){return+t[svg.yKey]}),svg.rDomain=d3.extent(svg.data,function(t){return+t[svg.rKey]}),svg.x=d3.scale.linear().domain(svg.xDomain).range([svg.radius+2*svg.pad,svg.w-svg.radius]),svg.y=d3.scale.linear().domain(svg.yDomain).range([svg.h-svg.radius-2*svg.pad,svg.radius]),svg.xA=d3.scale.linear().domain([0,100]).range([0,svg.w]),svg.yA=d3.scale.linear().domain([0,100]).range([svg.h,0]),svg.r=d3.scale.linear().domain(svg.rDomain).range([svg.radius/3,svg.radius]),svg.tDomain=d3.extent(svg.data,function(t){return+t[svg.tKey]}),svg.t=d3.scale.linear().domain(svg.tDomain).range([500,0]),svg.xAxis.scale(svg.xA),svg.yAxis.scale(svg.yA),svg.canvas.attr("width",svg.w).attr("height",svg.h),svg.xAxisGroup.attr("transform","translate(5, "+(svg.h-5)+")").call(svg.xAxis),svg.yAxisGroup.call(svg.yAxis),svg.legend.attr("transform",function(t,e){return"translate(0,"+e*svg.pad*1.5+")"}),svg.legend.selectAll("text").attr("x",svg.w-1.5*svg.pad).attr("y",svg.pad/2),svg.legend.selectAll("circle").attr("cx",svg.w-svg.pad/2).attr("cy",svg.pad/2).attr("r",svg.pad/2),svg.radiusLegend.attr("transform",function(t,e){return"translate(0,"+((svg.cDomain.domain().length+.5)*svg.pad*1.5+3*svg.pad)+")"}),svg.radiusLegend.selectAll("text").attr("x",svg.w-3.5*svg.pad),svg.radiusLegend.selectAll("circle").attr("cx",svg.w).attr("r",3*svg.pad),svg.xLabel.attr("x",svg.w).attr("y",svg.h-1.2*svg.pad),svg.yLabel.attr("y",svg.pad),svg.circles=svg.canvas.selectAll(".circle").data(svg.data,function(t){return t.collectionId});var t=svg.circles.enter().append("circle").attr("class","circle").style("fill",function(t){return"url(#artwork-"+t.collectionId+")"}).style("stroke",function(t){return svg.color(svg.cValue(t))}).attr("data-id",function(t){return t.collectionId}).attr("data-album",function(t){return t.collectionName}).attr("data-artist",function(t){return t.artistName}).attr("data-link",function(t){return t.trackViewUrl}).attr("data-zoomed",0).style("stroke-width",Math.floor(svg.radius/10)).attr("cx",function(t){return svg.x(+t[svg.xKey])}).attr("cy",function(t){return svg.y(+t[svg.yKey])}).attr("r",5).style("fill-opacity",1e-6).style("stroke-opacity",1e-6);t.on("mouseover",svg.hover),t.on("mouseout",svg.hoverOut),t.on("click",svg.click),t.append("svg:title").text(function(t){return t.collectionName+" — "+t.artistName}),svg.circles.transition().duration(500).delay(function(t){return svg.t(+t[svg.tKey])}).attr("cx",function(t){return svg.x(+t[svg.xKey])}).attr("cy",function(t){return svg.y(+t[svg.yKey])}).attr("r",function(t){return svg.r(+t[svg.rKey])}).style("stroke-width",Math.floor(svg.radius/10)).style("fill-opacity",1).style("stroke-opacity",1),svg.circles.exit().transition().duration(500).delay(function(t){return svg.t(+t[svg.tKey])}).attr("r",5).style("fill-opacity",1e-6).style("stroke-opacity",1e-6).remove()},svg.setupD3=function(t){if(d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},d3.selection.prototype.moveToBack=function(){return this.each(function(){var t=this.parentNode.firstChild;t&&this.parentNode.insertBefore(this,t)})},svg.yKey="totalPlays",svg.xKey="firstPlay",svg.rKey="numberOfTracks",svg.cKey="primaryGenreName",svg.tKey="lastPlay",svg.data=topAlbums,svg.dataByGenre=d3.nest().key(function(t){return t[svg.cKey]}).entries(svg.data),svg.cDomain=d3.scale.ordinal().domain(svg.data.map(function(t){return t[svg.cKey]})),svg.cValue=function(t){return t[svg.cKey]},svg.color=d3.scale.category20().domain(svg.cDomain.domain()),svg.canvas=d3.select("#graph").append("svg"),svg.canvas.on("click",svg.reset),svg.xAxisGroup=svg.canvas.append("g").attr("class","axis"),svg.yAxisGroup=svg.canvas.append("g").attr("class","axis").attr("transform","translate(5, -5)"),svg.xAxis=d3.svg.axis().orient("bottom").tickFormat(function(t){return""}),svg.yAxis=d3.svg.axis().orient("left").tickFormat(function(t){return""}),svg.canvas.append("defs").selectAll("pattern").data(svg.data).enter().append("pattern").attr("id",function(t){return"artwork-"+t.collectionId}).attr("x",0).attr("y",0).attr("width","100%").attr("height","100%").attr("viewBox","0 0 100 100").append("image").attr("xlink:href",function(t){return t.artworkUrl100}).attr("x",0).attr("y",0).attr("width",100).attr("height",100),svg.legend=svg.canvas.selectAll(".legend").data(svg.color.domain()).enter().append("g").attr("class",function(t){return window.location.hash.length<2?"legend":svg.genreShortName(t)===window.location.hash.substring(1)?"legend active":"legend"}).attr("data-id",function(t){return t}),svg.legend.on("click",svg.filter),svg.legend.append("circle").style("fill",svg.color),svg.legend.append("text").attr("dy","0.35em").style("text-anchor","end").text(function(t){return t}),svg.legend.append("svg:title").text(function(t){return"Filter by "+t+" genre"}),svg.radiusLegend=svg.canvas.append("g").attr("class","radius-legend"),svg.radiusLegend.append("text").attr("dy","0.35em").style("text-anchor","end").text("no. of tracks in an album"),svg.radiusLegend.append("circle").style("fill-opacity",0).attr("y",0).attr("stroke","#fff"),svg.radiusLegend.append("svg:title").text("Radius of circles corelates to a number of popular songs in a particular album"),svg.xLabel=svg.canvas.append("g").attr("class","label").append("text").attr("dy",".35em").style("text-anchor","end").text("release date"),svg.yLabel=svg.canvas.append("g").attr("class","label").append("text").attr("transform","rotate(-90)").attr("dy",".35em").attr("x",0).style("text-anchor","end").text("amount of plays"),svg.active=d3.select(null),svg.genre=d3.select(".legend.active"),window.location.hash.length>2)for(var e=window.location.hash.substring(1),a=0;a<svg.dataByGenre.length;a++)if(svg.genreShortName(svg.dataByGenre[a].key)===e){svg.data=svg.dataByGenre[a].values;var r=dom.title.getAttribute("data-text").split("100 ");dom.title.textContent=r[0]+"100 "+svg.dataByGenre[a].key+" "+r[1];break}svg.drawD3(),window.addEventListener("resize",svg.drawD3)},dom.listing=document.getElementById("listing"),dom.tracks=document.querySelectorAll(".show-track"),dom.selectedArtwork=document.getElementById("selected-artwork"),dom.selectedTrack=document.getElementById("selected-track-link"),dom.selectedLink=document.getElementById("selected-link"),dom.footer=document.getElementById("footer"),dom.title=document.getElementById("title"),dom.graph=document.getElementById("graph"),dom.close=document.getElementById("close"),dom.now=document.getElementById("now"),dom.cover=document.getElementById("cover"),dom.play=document.getElementById("play"),dom.audio=document.getElementById("audio"),dom.links=document.getElementById("links").children,global.navClick=function(t){t.preventDefault(),window.location.href=t.target.href},global.createCookie=function(t,e,a){var r="";if(a){var s=new Date;s.setTime(s.getTime()+24*a*60*60*1e3),r="; expires="+s.toGMTString()}document.cookie=t+"="+e+r+"; path=/"},global.readCookie=function(t){for(var e=t+"=",a=document.cookie.split(";"),r=0;r<a.length;r++){for(var s=a[r];" "===s.charAt(0);)s=s.substring(1,s.length);if(0===s.indexOf(e))return s.substring(e.length,s.length)}return null},global.updateUrls=function(t){if(global.createCookie("country",t,30),"us"!==t&&"undefined"!=typeof Storage){var e=[];dom.listing?e=dom.listing.querySelectorAll("a.preview"):dom.now&&(e=dom.now.querySelectorAll("a.preview"));for(var a=0;a<e.length;a++){var r=e[a].getAttribute("data-target-id");if(url=localStorage.getItem(r+"-"+t))e[a].href=url;else{var s=encodeURIComponent(e[a].getAttribute("data-artist")+" "+e[a].getAttribute("data-album")+" "+e[a].getAttribute("data-track"));global.loadScript("http://itunes.apple.com/search?term="+s+"&media=music&entity=song&limit=1&callback=processTrack&country="+t)}}}},global.easeInOut=function(t,e,a,r){return t/=r/2,1>t?a/2*t*t+e:(t-=1,-a/2*(t*(t-2)-1)+e)},global.scrollTo=function(t,e,a){var r=t.scrollTop,s=e-r,o=20,n=function(e){e+=o;var l=global.easeInOut(e,r,s,a);t.scrollTop=l,a>e&&setTimeout(function(){n(e)},o)};n(0)},global.selectTrack=function(t){var e=t.getAttribute("data-src");dom.selectedArtwork.src=e,dom.selectedArtwork.className="",t.className+=" selected",dom.selectedArtwork.alt=dom.selectedTrack.textContent=t.title,dom.selectedTrack.href=dom.selectedLink.href=t.getElementsByTagName("a")[0].href;var a=global.getImageWidth(dom.selectedArtwork.offsetWidth),r=new Image;r.onload=function(){dom.selectedArtwork.src=r.src,dom.selectedArtwork.className="loaded"},r.src=e.replace("100x100",a+"x"+a),dom.listing.scrollTop&&global.scrollTo(listing,0,500)},global.clickTrack=function(t){"TR"!==this.tagName&&t.preventDefault(),dom.body.className="listing-open";var e=dom.listing.querySelector("tr.selected");e&&(e.className=e.className.replace(" selected",""));var a=this.getAttribute("data-target-id"),r=document.getElementById("track-"+a);r&&(global.selectTrack(r),history.pushState({},"","#"+a))},window.location.hash.length>2){var target=document.getElementById("track-"+window.location.hash.substring(1));target&&(dom.body.className="listing-open",global.selectTrack(target))}if(dom.close&&dom.close.addEventListener("click",function(t){t.preventDefault(),dom.body.className="",history.pushState({},"","#")},!1),dom.listing)for(var i=0;i<dom.tracks.length;i++)dom.tracks[i].addEventListener("click",global.clickTrack,!0);dom.graph&&global.loadScript("http://d3js.org/d3.v3.min.js",svg.setupD3),global.playPause=function(){dom.cover.className.length?(dom.cover.className="",dom.play.textContent="play",dom.cover.title="Play",dom.audio.pause()):(dom.cover.className="playing",dom.play.textContent="pause",dom.cover.title="Pause",dom.audio.play())},dom.cover&&dom.cover.addEventListener("click",global.playPause,!0);for(var i=0;i<dom.links.length;i++)dom.links[i].addEventListener("click",global.navClick,!0);global.country=global.readCookie("country"),global.country?global.updateUrls(global.country):global.loadScript("http://ipinfo.io/?callback=processGeolocation");